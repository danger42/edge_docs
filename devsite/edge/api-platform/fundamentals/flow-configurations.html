  {% extends "_base.html" %} {% block title %}Configuring flows{% endblock %} {% block body %}

  <p>Flows are the basic building blocks of API proxies. Flows enable you to program the behavior
  of an API by letting you configure the sequence in which policies and code are executed by an API
  proxy.</p>

  <p>For a conceptual overview of flows, see <a href=
  "/api-platform/fundamentals/what-are-flows.html">Controlling how a proxy executes with
  flows</a>.</p>

  <p>This topic describes how to create conditional flows and add logic (policies) to flows at a
  high level. The art of creating conditions involves more detail than what's covered in this
  topic. For that detail, see <a href=
  "/api-platform/fundamentals/introduction-flow-variables.html">Managing proxy state with flow
  variables</a> and <a href="/api-platform/fundamentals/flow-variables-and-conditions.html">Flow
  variables and conditions</a>.</p>

  <h2 id="attachingpoliciestoflows">Attaching policies to flows</h2>

  <p>Edge comes with many different types of predefined policies to implement security, manage
  traffic, and manipulate messages. In addition, policies let you add your own custom code to
  completely customize message processing.</p>

  <p>For example:</p>

  <ul>
    <li>Attach an <strong>OAuth security </strong>policy to
    the <strong>request PreFlow of the ProxyEndpoint</strong>. Because the
    ProxyEndpoint's request PreFlow is the first flow in the pipeline, you can immediately
    reject a request if it violates your security policies.</li>

    <li>Attach a <strong>JSON to XML conversion </strong>policy to
    the <strong>response PostFlow of the TargetEndpoint</strong> to convert a
    response from JSON to XML.</li>

    <li>Attach a <strong>JavaScript </strong>policy to a <strong>Conditional
    Flow of the ProxyEndpoint </strong>to execute JavaScript code to process the
    request</li>
  </ul>

  <p>Once you have created a conditional flow, it is available for policy attachment. With the flow
  selected, click the <strong>+ Step</strong> icon in the request or response diagram to add a
  new or existing policy to the flow.</p>

  <p><img alt="" src="/api-platform/images/add_policy_to_flow.png"></p>

  <p><img alt="" src="/api-platform/images/add_quota_policy_to_flow.png"></p>

  <p>By attaching the policy to the selected flow, you are configuring the API proxy to enforce the
  Quota policy only for requests made to that flow URI and verb combination. For example, if you
  attach the policy to the <strong>learn</strong> flow in the request, the following XML is
  generated in the code view of the proxy editor:</p>
  <pre class="prettyprint">
&lt;ProxyEndpoint name="default"&gt;
...
   &lt;Flow name="<strong>issue</strong>"&gt;
        &lt;Description/&gt;
        &lt;Request&gt;
            &lt;Step&gt;
                &lt;Name&gt;<strong>Quota-2</strong>&lt;/Name&gt;
            &lt;/Step&gt;
        &lt;/Request&gt;
        &lt;Response/&gt;
        <strong>&lt;Condition&gt;(proxy.pathsuffix MatchesPath "/issue/**") and (request.verb = "GET")&lt;/Condition&gt;</strong>
    &lt;/Flow&gt;
... 
&lt;/ProxyEndpoint&gt;
</pre>

  <p>In this configuration, if a <strong>GET</strong> request comes in on the API proxy with a URI
  pattern of ...<strong>/issue/**</strong> (/issue/ with anything in the URI after the last forward
  slash), quota is enforced on that API call.</p>

  <h2 id="aboutconditionalflows">About conditional flows</h2>

  <p>Any policies attached to the PreFlow or PostFlow are always executed. However, the
  policies in a conditional flow are executed only if the flow's condition evaluates to true.</p>

  <p>During the processing of a request and response, only one conditional flow is executed per
  segment--the first flow whose condition evaluates to true. That means you can have one
  conditional flow executed as part of each of the:</p>

  <ul>
    <li>ProxyEndpoint's request pipeline</li>

    <li>TargetEndpoint's request pipeline</li>

    <li>ProxyEndpoint's response pipeline</li>

    <li>TargetEndpoint's response pipeline</li>
  </ul>

  <div class="video">
    <p><strong>Video:</strong> Watch a short video to learn more about conditional flows.</p>

    <div style="text-align: left; margin:15px">
      <iframe allowfullscreen="" frameborder="0" height="480" src=
      "https://www.youtube.com/embed/H3dbycHbPpA" width="560"></iframe>
    </div>
  </div>

  <p>For example, the following ProxyEndpoint definition shows a conditional flow that is executed
  by the ProxyEndpoint on any HTTP GET request to the API proxy:</p>
  <pre class="prettyprint">
&lt;ProxyEndpoint name="default"&gt;
  &lt;PreFlow&gt;
    &lt;Request/&gt;
    &lt;Response/&gt;
  &lt;/PreFlow&gt;   
<strong>  &lt;Flows&gt;
    &lt;Flow name="Flow-1"&gt;
      &lt;Condition&gt;request.verb="GET"&lt;/Condition&gt;
      &lt;Request/&gt;
      &lt;Response/&gt;
    &lt;/Flow&gt;
  &lt;/Flows&gt;</strong>
  &lt;PostFlow&gt;
    &lt;Request/&gt;
    &lt;Response/&gt;
  &lt;/PostFlow&gt;
  ...
&lt;/ProxyEndpoint&gt;
</pre>

  <p>Notice that the condition references the <span style=
  "font-family: 'courier new', courier, monospace;">request.verb</span> <em>flow
  variable</em>. A flow variable is named references that hold state information associated
  with an API transaction processed by Edge. Edge defines many state variables that you can
  reference.</p>

  <p>RESTful services are collections of API resources. An API resource is a URI path fragment
  that identifies some entity that developers can access by calling your API. For example, if your
  service backend provides weather reports and weather forecasts, your API might define two
  conditional flows that map to those API
  resources: <code>/reports</code> and <code>/forecasts</code>. When an API call
  includes one of those resources in the URL, the condition evaluates to true and the logic
  attached to the conditional flow is executed.</p>

  <p>App developers then access your resources by making requests to a URL in the form:</p>
  <pre class="prettyprint">
http://myAPIs.myCo.com/weather/reports
</pre>

  <p>or:</p>
  <pre class="prettyprint">
http://myAPIs.myCo.com/weather/forecasts
</pre>

  <p>In an API proxy, you can define a conditional flow that corresponds to a specific
  resource:</p>
  <pre class="prettyprint">
&lt;ProxyEndpoint name="default"&gt;
  &lt;PreFlow&gt;
    &lt;Request/&gt;
    &lt;Response/&gt;
  &lt;/PreFlow&gt;   
<strong>  &lt;Flows&gt;
    &lt;Flow name="Flow-1"&gt;
      &lt;Condition&gt;(proxy.pathsuffix MatchesPath "/reports")&lt;/Condition&gt;</strong>
<strong>      &lt;Request/&gt;
      &lt;Response/&gt;
    &lt;/Flow&gt;
    &lt;Flow name="Flow-2"&gt;
      &lt;Condition&gt;(proxy.pathsuffix MatchesPath "/forecasts")&lt;/Condition&gt;</strong>
<strong>      &lt;Request/&gt;
      &lt;Response/&gt;
    &lt;/Flow&gt;
  &lt;/Flows&gt;
</strong>  &lt;PostFlow&gt;
    &lt;Request/&gt;
    &lt;Response/&gt;
  &lt;/PostFlow&gt;
  ...
&lt;/ProxyEndpoint&gt;
</pre>

  <p>In this example, you reference the <code>proxy.pathsuffix</code> flow variable,
  which contains the suffix portion of the URL used to access the API proxy. You can then attach
  different policies to the conditional flow for each resource.</p>

  <h2 id="addingaconditionalflow">Adding a conditional flow</h2>

  <p>In this brief example, you set up a flow that executes only when the request message is an
  HTTP GET.</p>

  <p>To add a conditional flow, select the <b>Develop</b> view in the API proxy builder. Click the
  <strong>+ icon</strong> in the desired endpoint.</p>

  <p><img alt="" src="/api-platform/images/add_conditional_flow.png"></p>

  <p>The New Conditional Flow form lets you name the flow and configure a condition. In the
  following example, you add a simple condition that evaluates the HTTP of the request message for
  a GET verb (as opposed to PUT, POST, etc.) on any URI after the base path.</p>

  <p><img alt="" src="/api-platform/images/add_conditional_flow_get2.png"></p>

  <p>(Learn how to construct conditional statements in <a href=
  "/api-platform/fundamentals/flow-variables-and-conditions.html">Flow variables and
  conditions</a>.)</p>

  <p>The new flow, called <code>Flow-1</code>, now appears in the Navigator menu.</p>

  <p><img alt="" src="/api-platform/images/add_conditional_flow_navigator.png"></p>

  <p>Now observe the XML configuration for the ProxyEndpoint. Select <b>Flow-1</b> in the
  <b>Navigator</b> menu.</p>

  <p>You will see the following configuration.</p>
  <pre class="prettyprint">
&lt;PreFlow name="PreFlow"&gt;
    &lt;Request/&gt;
    &lt;Response/&gt;
&lt;/PreFlow&gt;   
&lt;Flows&gt;
    &lt;Flow name="Flow-1"&gt;
      &lt;Request/&gt;
      &lt;Response/&gt;
      &lt;Condition&gt;(proxy.pathsuffix MatchesPath "/**") and (request.verb = "GET")&lt;/Condition&gt;
    &lt;/Flow&gt;
&lt;/Flows&gt;
&lt;PostFlow name="PostFlow"&gt;
    &lt;Request/&gt;
    &lt;Response/&gt;
&lt;/PostFlow&gt;
</pre>

  <h2 id="nextsteps">Next steps</h2>

  <p>The following topics provide more detail about constructing conditions and using
  variables:</p>

  <ul>
    <li><a href="/api-platform/fundamentals/introduction-flow-variables.html">Managing proxy state
    with flow variables</a></li>

    <li><a href="/api-platform/fundamentals/flow-variables-and-conditions.html">Flow variables and
    conditions</a></li>

    <li><a href="/api-platform/fundamentals/uri-based-configurations.html">Mapping conditional
    flows to backend API resources</a></li>
  </ul>{% endblock %}
