{% extends "_base.html" %}
{% block title %}Enable SAML{% endblock %}
{% block body %}

  <p>With SAML enabled, access to the Edge management API continues to use OAuth2
  access tokens. These tokens are generated by the Edge SSO which now accepts SAML assertions
  returned by your identity provider. The Edge SSO is configured as a SAML service provider to your
  SAML2 compliant identity provider.</p>

  <p>You enable SAML at the organization level through Edge identity zones. That means every
  organization that you want to support SAML authentication must be added to an Edge identity
  zone.</p>

  <p><strong>To enable SAML:</strong></p>
  <ol>
    <li>Contact {{support}} and let them know you want to enable SAML.</li>
    <li>Provide the following information to Apigee:
      <ul>
        <li>A zone name (all lowercase, no special characters)</li>
        <li>The list of organizations for which you want to enable SAML</li>
        <li>The metadata URL of the SAML identity provider </li>
        <li>List of developer portals and the Edge organizations that are associated with the
          portals</li>
        <li>Any modification you made to Drupal modules as part of customizing the portals</li>
      </ul>
      <p>Apigee configures the identity zone to interact with your SAML identity provider and
      returns information that you then use to configure your identity provider.</p>
    </li>
    <li>Add existing organization users to the SAML identity
      provider, as described in <a href="#registering">Registering new Edge UI users with SAML</a>.
      All users require an email address that is returned to the Edge UI as part of the SAML
      authentication process.
      <p>Before you convert an Edge organization to use SAML, you should have already added all
      existing organization users to your SAML identity provider. After you enable SAML, existing
      users will not be able to log in to the Edge UI until they are added to the SAML identity
      provider.</p>
    </li>
    <li>Configure your identity provider with the following information from Apigee:
      <ul>
        <li>The service provider metadata URL for you to add to your identity provider. The URL
          contains your zone name, in the form:
          <pre class="prettyprint">https://<var>zoneName</var>.login.apigee.com/saml/metadata/alias/<var>zoneName</var>.apigee-saml-login</pre>
        </li>
        <li>The EntityID, in the form:
          <pre class="prettyprint"><var>zoneName</var>.apigee-saml-login</pre>
        </li>
        <li>Name ID format, in the form:
          <pre class="prettyprint">urn:oasis:names:tc:SAML:1.1:nameid-format:<var>emailAddress</var></pre>
          <aside class="note">
            <h3 class="hide-from-toc">NOTE</h3> Edge requires an email address to identify the user.
            Therefore, the identity provider must return an email address.</aside>
        </li>
        <li>Assertion Consumer Service (ACS) URL, in the form:
          <pre class="prettyprint">https://<var>zoneName</var>.login.apigee.com/saml/SSO/alias/<var>zoneName</var>.apigee-saml-login</pre>
        </li>
      </ul>
    </li>
    <li>You can now access the UI or the management API with SAML. For more information, see
      <a href="using-saml">Using SAML to access the management API</a>.</li>
    <li>Update any scripts that use Basic Authentication to now use SAML assertions, as described in
      <a href="#remove-basic">Remove Basic Auth</a>.</li>
  </ol>

  <p>You only have to inform Apigee of your zone name and the names of the Edge organizations that
  you want to include in the zone. Apigee then creates the zone on Edge, and adds your Edge
  organizations to the zone. See <a href="#pre-reqs">Prerequisites for enabling SAML</a> for more.</p>

  <h2 id="remove-basic">Remove Basic Auth</h2>

  <p>After you enable SAML, Basic Auth is disabled for the Edge management API. That means all
  scripts (Maven scripts, shell scripts, <code>apigeetool</code>, etc.) that rely on Edge
  management API calls supporting Basic Auth no longer work. You must update any API calls and
  scripts that use Basic Auth to pass OAuth2 access tokens in the Bearer header.</p>

  <aside class="note"><h3 class="hide-from-toc">NOTE</h3> The URL for the Edge management API is
    not affected by enabling SAML authentication. You still access the management API at:
    <pre class="prettyprint">https://api.enterprise.apigee.com/v1</pre>
  </aside>

  <p>You must update any API calls and scripts to use OAuth2 bearer tokens. See <a href=
  "using-saml">Using SAML with the management API</a>.</p>

  <h2 id="identity">Use an identity zone to access your organization</h2>

  <p>The URL that you use to access the Edge UI is defined by the name of your identity zone:</p>
  <pre class="prettyprint">https://<var>zoneName</var>.enterprise.apigee.com</pre>

  <p>For example, Acme Inc. wants to use SAML and chooses "acme" as its zone name. Acme
  Inc. customers then access the Edge UI with the following URL:</p>
  <pre class="prettyprint">https://<strong>acme</strong>.enterprise.apigee.com</pre>

  <p>The zone identifies the Edge organizations that support SAML. For example, Acme Inc. has three
  orgs: OrgA, OrgB and OrgC. Acme can decide to add all organizations to the SAML zone, or only a
  subset. The remaining organizations continue to use Basic Auth or OAuth2 tokens generated from
  Basic Auth credentials.</p>

  <p>You can define multiple identity zones. All zones can then be configured to use the same
  identity provider.</p>

  <p>For example, Acme might want to define a production zone, "acme-prod", containing OrgAProd and
  OrgBProd, and a test zone, "acme-test", containing OrgATest, OrgBTest, OrgADev, and OrgBDev.</p>

  <p>You then use the following URLs to access the different zones:</p>
  <pre class="prettyprint">https://<strong>acme-prod</strong>.enterprise.apigee.com
https://<strong>acme-test</strong>.enterprise.apigee.com</pre>

  <h2 id="registering">Registering new Edge UI users with SAML authentication</h2>

  <p>After you enable SAML for an organization, you need to register any new SAML users that are
  not already registered with your organization by performing the following steps:</p>
  <ol>
    <li>The user registers with the SAML identity provider.</li>
    <li>An organization administrator adds the user to the Edge UI as described in
      <a href="/api-platform/system-administration/adding-global-users">Adding global users</a>.
      <ol>
        <li>Select <strong>Admin &gt; Organization Users</strong> in the Edge UI</li>
        <li>Select <strong>+User</strong>.</li>
        <li>Enter the user's email address.</li>
        <li>Enter the user's role.</li>
        <li>Click <strong>Save</strong>.</li>
      </ol>
    </li>
    <li>The user logs in to the Edge UI.</li>
  </ol>

  <h3>Add existing organization users to the SAML identity provider</h3>

  <p>Before you convert an Edge organization to use SAML, you should have already added all
  existing organization users to your SAML identity provider. After you enable SAML, existing users
  will not be able to log in to the Edge UI until they are added to the SAML identity provider.</p>

  <aside class="note"><h3 class="hide-from-toc">NOTE</h3> All users require an email address that is
  returned to the Edge UI as part of the SAML authentication process.</aside>

  <h2 id="disabling-saml">Disable SAML</h2>

  <p>You might later decide to disable SAML and return to Basic Auth. If you decide to disable
  SAML:</p>

  <ul>
    <li>Open a ticket with {{support}} and coordinate the disabling of SAML.</li>
    <li>Once SAML is disabled, users must select the <strong>Reset password</strong> link
      on the Edge UI login page to set a new password.</li>
    <li>If you choose to enable SAML again in the future, Apigee might require you to re-enter
      your details.</li>
  </ul>

{% endblock %}
