{% extends "_base.html" %}
{% block title %}Enabling SAML Authentication for Edge{% endblock %}
{% block body %}

  <p>SAML supports a single sign-on (SSO) environment. By using SAML with Edge, you can support SSO
  for the Edge UI and API in addition to any other services that you provide and that also support
  SAML.</p>

  <aside class="note"><strong>Note:</strong> SAML is supported as the authentication mechanism for
  the Cloud version of Edge and for Edge for the Private Cloud version 4.17.09 and later.
  </aside>

  <p>SAML authentication offers several advantages. By using SAML you can:</p>

  <ul>
    <li><strong>Take full control of user management:</strong> When users leave your organization
      and are deprovisioned centrally, they are automatically denied access to Edge.</li>
    <li><strong>Control how users authenticate to access Edge:</strong> You can choose different
      authentication types for different Edge organizations.</li>
    <li><strong>Control authentication policies:</strong> Your SAML provider may support
      authentication policies that are more in line with your enterprise standards.</li>
    <li><strong>Monitor logins, logouts, unsuccessful login attempts and high risk activities</strong>
      on your Edge deployment.</li>
  </ul>

  <p>Note that SAML is only used for authentication by the Edge UI and Edge management API.
  Authorization is still controlled by Edge user roles. See <a href=
  "/api-platform/system-administration/understanding-roles">Assigning roles</a> for more.</p>

  <h2 id="usingsamlwithedge">Using SAML with Edge</h2>

  <p>With SAML enabled, access to the Edge UI and Edge management API continues to use OAuth2
  access tokens. These tokens are generated by the Edge SSO which now accepts  SAML assertions
  returned by your identity provider. The Edge SSO is configured as a SAML service provider to your
  SAML2 compliant identity provider.</p>

  <p>You enable SAML at the organization level through Edge identity zones. That means every
  organization that you want to support SAML authentication must be added to an Edge identity
  zone.</p>

  <h3 id="usingsamlwithedge-aboutedgeidentityzones">About Edge identity zones</h3>

  <p>An Edge identity zone is an authentication realm that defines a SAML identity provider used
  for authentication. Only when a user authenticates with the identity provider can they access the
  Edge organizations and resources scoped to the zone.</p>

  <p>To enable SAML, you first specify the name of an identity zone and identity the Edge
  organizations that are in the zone. Apigee then configures the identity zone to interact with
  your SAML identity provider.</p>

  <aside class="note"><b>Note:</b> You only have to inform Apigee of your zone name and the names
  of the Edge organizations that you want to include in the zone. Apigee then creates the zone on
  Edge, and adds your Edge organizations to the zone. See <a href=
  "#enablingsamlforedge-informationrequiredbyapigeetoenablesaml">Information required by Apigee to
  enable SAML</a> below for more.</aside>

  <h3 id="usingsamlwithedge-usinganidentityzonetoaccessyourorganization">Using an identity zone to
  access your organization</h3>

  <p>The URL that you use to access the Edge UI is defined by the name of your identity zone:</p>
  <pre class="prettyprint">https://<var>zoneName</var>.enterprise.apigee.com</pre>

  <p>For example, Acme Inc. wants to use SAML and chooses &#8220;acme&#8221; as its zone name. Acme
  Inc. customers then access the Edge UI with the following URL:</p>
  <pre class="prettyprint">https://<strong>acme</strong>.enterprise.apigee.com</pre>

  <p>The zone identifies the Edge organizations that support SAML. For example, Acme Inc. has three
  orgs: OrgA, OrgB and OrgC. Acme can decide to add all organizations to the SAML zone, or only a
  subset. The remaining organizations continue to use Basic Auth or OAuth2 tokens generated from
  Basic Auth credentials.</p>

  <p>After successful authentication through SAML, the Edge UI user is redirected to an Edge
  organization:</p>
  <pre class="prettyprint">https://<var>zoneName</var>.enterprise.apigee.com/platform/<var>orgName</var></pre>

  <p>For example:</p>
  <pre class="prettyprint">https://<strong>acme</strong>.enterprise.apigee.com/platform/<strong>OrgA</strong></pre>

  <p>One option is to define multiple identity zones. All zones can then be configured to use the
  same identity provider.</p>

  <p>For example, Acme might want to define a production zone, "acme-prod", containing OrgAProd and
  OrgBProd, and a test zone, "acme-test", containing OrgATest, OrgBTest, OrgADev, and OrgBDev.</p>

  <p>You then use the following URLs to access the different zones:</p>
  <pre class="prettyprint">https://<strong>acme-prod</strong>.enterprise.apigee.com
https://<strong>acme-test</strong>.enterprise.apigee.com</pre>

  <h2 id="same-with-ui">Using SAML with the Edge UI</h2>

  <p>The SAML specification defines three entities: </p>

  <ul>
    <li>Principal (Edge UI user)</li>
    <li>Service provider (Edge SSO) </li>
    <li>Identity provider (returns SAML assertion)</li>
  </ul>

  <p>When SAML is enabled, the principal (an Edge UI user) requests access to the service provider
  (Edge SSO). Edge SSO (in it's role as a SAML service provider) then requests and obtains an
  identity assertion from the SAML identity provider and uses that assertion to create the OAuth2
  token required to access the Edge UI. The user is then redirected to the Edge UI.</p>

  <p>This process is shown below:</p>

  <p><img alt="" src="/private-cloud/images/saml_v3.png"></p>

  <p>In this diagram:</p>
  <ol>
    <li>User attempts to access the Edge UI by making a request to the login domain for the Edge
      SSO, which includes the zone name. For example,
      <code>https://<var>zoneName</var>.login.apigee.com</code>
    </li>
    <li>Unauthenticated requests to <code>https://<var>zoneName</var>.login.apigee.com</code>
    are redirected to the customer's SAML identity provider. For example,
    <code>https://idp.customer.com</code>.</li>
    <li>If customer is not logged in to the identity provider, the customer is prompted to log
    in.</li>
    <li>The user is authenticated by the SAML identity provider. The SAML identity provider
    generates and returns a SAML 2.0 assertion to the Edge SSO.</li>
    <li>Edge SSO validates the assertion, extracts the user identity from the assertion, generates
      the OAuth 2 authentication token for the Edge UI, and redirects the user to the main Edge UI
      page at:
      <pre class="prettyprint">https://<var>zoneName</var>.enterprise.apigee.com/platform/<var>orgName</var></pre>
      <p>where <var>orgName</var> is the name of an Edge organization.</p>
    </li>
  </ol>

  <h2 id="saml-with-management-api">Using SAML with the Edge management API</h2>

  <p>Basic Auth is one way to authenticate when making calls to the Edge management API. For
  example, you can make the following cURL request to the Edge management API to access information
  about your organization:</p>

  <pre class="devsite-terminal">curl <strong>-u</strong> <var>userEMail:pWord</var> https://api.enterprise.apigee.com/v1/organizations/<var>orgName</var>
</pre>

  <p>In this example, you use the cURL -u option to pass Basic Auth credentials. Alternatively, you
  can pass an OAuth2 token in the Bearer header to make Edge management API calls. For example:</p>

  <pre class="devsite-terminal">curl <strong>-H "Authorization: Bearer &lt;access_token&gt;"</strong> https://api.enterprise.apigee.com/v1/organizations/<var>orgName</var></pre>

  <p>After you enable SAML, Basic Auth is disabled for the Edge management API. That means all
  scripts (Maven scripts, shell scripts, <code>apigeetool</code>, etc.) that rely on Edge
  management API calls supporting Basic Auth no longer work. You must update any API calls and
  scripts that use Basic Auth to pass OAuth2 access tokens in the Bearer header.</p>

  <aside class="note"><strong>Note:</strong> The URL for the Edge management API is not affected by
    enabling SAML authentication. You still access the management API at:
    <pre class="prettyprint">https://api.enterprise.apigee.com/v1</pre>
  </aside>

  <p>The following procedure describes how to obtain an OAuth2 access token to make Edge management
  API calls:</p>

  <ol>
    <li>You use the <code>get_token</code> utility, provided with Edge, to exchange your SAML
    assertion for an OAuth2 access token. Install the <code>get_token</code> utility as
    described in <a href="/api-services/content/using-oauth2-security-apigee-edge-management-api">Using OAuth2 security
    with the Apigee Edge management API</a>.</li>

    <li>Set the <code>SSO_LOGIN_URL</code> environment variable to your login URL. The login URL has
      the form:
      <pre class="prettyprint">https://<var>zoneName</var>.login.apigee.com</pre>

      <p>For example, for a zone named "acme", set <code>SSO_LOGIN_URL</code> as:
      <pre class="devsite-terminal">export SSO_LOGIN_URL=https://acme.login.apigee.com</pre>
    </li>

    <li>In a browser, go to the following URL to obtain a one-time passcode:
      <pre class="prettyprint">https://<var>zoneName</var>.login.apigee.com/passcode</pre>

      <p>For example, for a zone named "acme", go to the URL:
      <pre class="prettyprint">https://acme.login.apigee.com/passcode</pre>

      <aside class="note"><strong>Note</strong>: If you are not currently logged in by your identity
      provider, you will be prompted to log in.</aside>

      <p>This URL returns a one-time passcode that remains valid until you refresh that URL to obtain a
      new passcode, or you use the passcode with <code>get_token</code> to generate an access
      token.</p>
    </li>

    <li>Invoke <code>get_token</code> to obtain the OAuth2 access token:<br>
      <pre class="devsite-terminal">get_token</pre>

      <p>You are prompted to enter the one-time passcode that you obtained in step 3:
      <pre class="prettyprint">One Time Code ( Get one at https://acme.login.apigee.com/passcode )
Enter the passcode if SAML is enabled or press ENTER:</pre>

      <p>Enter the passcode. The <code>get_token</code> utility obtains the OAuth2 access token,
      prints it to the screen, and writes it and the refresh token to <code>~/.sso-cli</code>.</p>
    </li>

    <li>Pass the access token to an Edge management API call as the Bearer header:
      <pre class="devsite-terminal">curl <strong>-H "Authorization: Bearer &lt;access_token&gt;"</strong>
  https://api.enterprise.apigee.com/v1/organizations/<var>orgName</var></pre>
      <p>After you obtain a new access token for the first time, you can obtain the access token and
      pass it to an API call in a single command, as shown below:
      <pre class="devsite-terminal"><strong>header='get_token'</strong> &amp;&amp; curl <strong>-H "Authorization: Bearer $header"</strong> \
  https://api.enterprise.apigee.com/v1/o/<var>orgName</var></pre>
      <p>With this form of the command, if the access token has expired, it is automatically refreshed
      until the refresh token expires.</p>
    </li>
  </ol>

  <p>After the refresh token expires, <code>get_token</code> prompts you for a new
  passcode. You must go to the URL shown above in Step 3 and generate a new passcode before you can
  generate a new OAuth access token.</p>

  <h3 id="usingsamlwiththeedgemanagementapi-usingthemanagementapitogetandrefreshtokens">Using the
  management API to get and refresh tokens</h3>

  <p>The <a href="/api-services/content/using-oauth2-security-apigee-edge-management-api#usingtheapi">Using the API</a>
  section of <a href="/api-services/content/using-oauth2-security-apigee-edge-management-api">Using OAuth2 security
  with the Apigee Edge management API</a> contains instructions that show how to use the Edge
  management API to obtain and refresh tokens. You can also use Edge API calls to for tokens
  generated from SAML assertions.</p>

  <p>The only difference between the API calls documented in the <a href=
  "/api-services/content/using-oauth2-security-apigee-edge-management-api#usingtheapi">Using the
  API</a> section is that the URL of the call must reference your zone name. In addition, for
  generating the initial access token, you must include the passcode, as shown in step 3 of the
  procedure above.</p>

  <p>For example, use the following API call to generate the initial access and refresh
  tokens:</p>

  <pre class="devsite-terminal">curl -H "Content-Type: application/x-www-form-urlencoded;charset=utf-8" \
  -H "accept: application/json;charset=utf-8" \
  -H "Authorization: Basic ZWRnZWNsaTplZGdlY2xpc2VjcmV0" -X POST \
  https://<var>zoneName</var>.login.apigee.com/oauth/token -s \
  -d 'grant_type=password&amp;response_type=token<strong>&amp;passcode=UKB3Wn</strong>'</pre>

  <p>For authorization, pass a reserved OAuth2 client credential in the <code>Authorization</code>
  header. The call prints the access and refresh tokens to the screen.</p>

  <p>To later refresh the access token, use the following call that includes the refresh
  token:</p>

  <pre class="devsite-terminal">curl -H "Content-Type:application/x-www-form-urlencoded;charset=utf-8" \
  -H "Accept: application/json;charset=utf-8" \
  -H "Authorization: Basic ZWRnZWNsaTplZGdlY2xpc2VjcmV0" -X POST \
  https://<var>zoneName</var>.login.apigee.com/oauth/token \
  -d 'grant_type=refresh_token&amp;refresh_token=<var>refreshToken</var>'</pre>

  <h2 id="enable-saml-tasks">Considerations before you enable SAML</h2>

  <p>Before you request SAML activation, you should do the following:</p>
  <ul>
    <li><strong>Organization users:</strong> Add existing organization users to the SAML identity
      provider, as described in <a href="#registering">Registering new Edge UI users with SAML</a>. All users
      require an email address that is returned to the Edge UI as part of the SAML authentication
      process.
      <p>Before you convert an Edge organization to use SAML, you should have already added all
      existing organization users to your SAML identity provider. After you enable SAML, existing
      users will not be able to log in to the Edge UI until they are added to the SAML identity
      provider.</p>
    </li>
    <li>If you use a Developer Services portal, coordinate with Apigee Support to update your
      portal.</li>
    <li><strong>Classic or New Edge UI:</strong> Use the Classic Edge UI with SAML, or the New Edge
      UI (if you do not use the portal)</li>
    <li><strong>Update your scripts:</strong> Ensure that they do not use Basic Auth</li>
  </ul>

  <p>These issues are described in detail below.</p>

  <h3 id="considerationsbeforeyouenablesaml-addexistingorganizationuserstothesamlidentityprovider">
  Add existing organization users to the SAML identity provider</h3>

  <p>Before you convert an Edge organization to use SAML, you should have already added all
  existing organization users to your SAML identity provider. After you enable SAML, existing users
  will not be able to log in to the Edge UI until they are added to the SAML identity provider.</p>

  <aside class="note"><strong>Note:</strong> All users require an email address that is returned to
  the Edge UI as part of the SAML authentication process.</aside>

  <p>For information on adding new users to Edge after enabling SAML, see <a href=
  "#new-ui-saml">Registering new Edge UI users with SAML</a>
  below.</p>


  <h3 id="classic-ui-with-saml">Use the Classic Edge UI with SAML</h3>

  <p>Apigee recommends that you use the classic Edge UI with SAML. You can use the New Edge UI, but
  the portal feature of the new UI does not support SAML.</p>

  <h3 id="no-basic-auth">Make sure your scripts do not use Basic Auth</h3>

  <p>After you enable SAML, Basic Auth is disabled for the Edge management API. Also, any scripts
  (Maven scripts, shell scripts, apigeetool, etc.) that rely on Edge API calls supporting Basic
  Auth no longer work.</p>

  <p>You must update any API calls and scripts to use OAuth2 bearer tokens. See <a href=
  "#saml-with-management-api">Use SAML with the Edge management API</a>.</p>

  <h2 id="enablingsamlforedge">Enable SAML for Edge</h2>

  <p>You must work with {{support}} to enable SAML.</p>

  <h3 id="required-info">Information required by Apigee to enable SAML</h3>

  <p>Existing customers should open a ticket with {{support}} requesting SAML support for one or
  more organizations. New customers can request SAML access during the Edge onboarding process.</p>

  <p>Information required to enable SAML:</p>

  <ul>
    <li>A zone name (all lowercase, no special characters)</li>
    <li>The list of organizations for which you want to enable SAML</li>
    <li>The metadata URL of the SAML identity provider </li>
    <li>List of developer portals and the Edge organizations that are associated with the
    portals</li>
    <li>Any modification you made to Drupal modules as part of customizing the portals</li>
  </ul>

  <h3 id="info-from-apigee">Information returned to you by Apigee</h3>

  <p>After SAML support is enabled, Apigee returns to you the following information that you need
  to use to configure your identity provider:</p>
  <ol>
    <li>The service provider metadata URL for you to add to your identity provider. The URL
      contains your zone name, in the form:
      <pre class="prettyprint">https://<var>zoneName</var>.login.apigee.com/saml/metadata/alias/<var>zoneName</var>.apigee-saml-login</pre>
    </li>
    <li>The EntityID, in the form:
      <pre class="prettyprint"><var>zoneName</var>.apigee-saml-login</pre>
    </li>
    <li>Name ID format, in the form:
      <pre class="prettyprint">urn:oasis:names:tc:SAML:1.1:nameid-format:<var>emailAddress</var></pre>
      <aside class="note"><strong>Note</strong>: Edge requires an email address to identify the
      user. Therefore, the identity provider must return an email address.</aside>
    </li>
    <li>Assertion Consumer Service (ACS) URL, in the form:
      <pre class="prettyprint">https://<var>zoneName</var>.login.apigee.com/saml/SSO/alias/<var>zoneName</var>.apigee-saml-login</pre>
    </li>
  </ol>

  <h3 id="disablingsaml">Disable SAML</h3>

  <p>You might later decide to disable SAML and return to Basic Auth. If you decide to disable
  SAML:</p>

  <ul>
    <li>Open a ticket with {{support}}.</li>
    <li>Users must select the <strong>Reset password</strong> link on the Edge UI login page to set
      a new password.</li>
    <li>If the customer chooses to sign up again in the future, Apigee might require them to
      re-enter their details.</li>
  </ul>

  <h2 id="registering">Registering new Edge UI users with SAML authentication</h2>

  <p>After you enable SAML for an organization, you need to register any new SAML users that are
  not already registered with your organization by performing the following steps:</p>
  <ol>
    <li>The user registers with the SAML identity provider.</li>
    <li>An organization administrator adds the user to the Edge UI as described in
      <a href="/api-platform/system-administration/adding-global-users">Adding global users</a>.
      <ol>
        <li>Select <strong>Admin &gt; Organization Users</strong> in the Edge UI</li>
        <li>Select <strong>+User</strong>.</li>
        <li>Enter the user's email address.</li>
        <li>Enter the user's role.</li>
        <li>Click <strong>Save</strong>.</li>
      </ol>
    </li>
    <li>The user logs in to the Edge UI.</li>
  </ol>

{% endblock %}
