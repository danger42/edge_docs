{% extends "private-cloud/v4.18.05/_base.html" %}
{% block title %}How to monitor{% endblock %}
{% block body %}

  <p>This document describes the monitoring techniques of components supported by an on-premise
  deployment of Apigee Edge.</p>

  <h2 id="enablingjmx">Enabling JMX</h2>

  <p>JMX is enabled by default for Cassandra, and disabled by default for all other Edge
  components. You must therefore enable JMX individually for each component.</p>

  <p>Each component supports JMX on a different port. The following table lists the JMX port and
  the file that you modify to enable JMX on that port:</p>
  <table>
    <thead>
      <tr>
        <th>Component</th>
        <th>JMX Port</th>
        <th>File</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Management Server</td>
        <td>1099</td>
        <td><code>/opt/apigee/edge-management-server/bin/start</code></td>
      </tr>
      <tr>
        <td>Router</td>
        <td>1100</td>
        <td><code>/opt/apigee/edge-router/bin/start</code></td>
      </tr>
      <tr>
        <td>Message Processor</td>
        <td>1101</td>
        <td><code>/opt/apigee/edge-message-processor/bin/start</code></td>
      </tr>
      <tr>
        <td>Qpid</td>
        <td>1102</td>
        <td><code>/opt/apigee/edge-qpid-server/bin/start</code></td>
      </tr>
      <tr>
        <td>Postgres</td>
        <td>1103</td>
        <td><code>/opt/apigee/edge-postgres-server/bin/start</code></td>
      </tr>
    </tbody>
  </table>

  <p>For example, to enable JMX on the Management Server, open
  <code>/opt/apigee/edge-management-server/bin/start</code> in an editor. You should see the
  following line used to start the Management Server:</p>
  <pre class="prettyprint">
exec $JAVA -classpath "$classpath" -Xms$min_mem -Xmx$max_mem $xx_opts
-Djava.security.auth.login.config=$conf_path/jaas.config
-Dinstallation.dir=$install_dir $sys_props -Dconf.dir=$conf_path
-Ddata.dir=$data_dir $* $debug_options com.apigee.kernel.MicroKernel
</pre>

  <p>Edit this line to add the following:</p>
  <pre class="prettyprint">
-Dcom.sun.management.jmxremote <strong>-Dcom.sun.management.jmxremote.port=1099</strong>
-Dcom.sun.management.jmxremote.local.only=false
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false
</pre>

  <p>Note that this line specifies the JMX port number as 1099 for the Management Server. Set the
  port number for each component as defined in the table above. For example:</p>
  <pre class="prettyprint">
exec $JAVA -classpath "$classpath" -Xms$min_mem -Xmx$max_mem $xx_opts
-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=1099
-Dcom.sun.management.jmxremote.local.only=false
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false
-Djava.security.auth.login.config=$conf_path/jaas.config
-Dinstallation.dir=$install_dir $sys_props
-Dconf.dir=$conf_path
-Ddata.dir=$data_dir $* $debug_options com.apigee.kernel.MicroKernel
</pre>

  <p>Save the file and then restart the component. For example to restart the Management
  Server:</p>
  <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/?apigee-service edge-management-server restart</pre>

  <h2 id="enablingjmxauthenticationandsettingthejmxpassword">Enabling JMX authentication and setting
  the JMX password</h2>

  <p>The monitoring process for the Management Server, Message Processor, Qpid, and Postgres all
  use JMX. JMX is enabled by default and remote JMX access does not require a password.</p>

  <p>To enable JMX authentication, each component has a <code>change_jmx_auth</code> action that you
  use to enable/disable authentication and to set the JMX credentials.</p>

  <aside class="note"><strong>Note:</strong> To enable JMX authentication for Cassandra, see
  <a href="#apachecassandra">Apache Cassandra</a>.</aside>

  <p>To enable JMX authentication, use the following command:</p>
  <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service <var>comp</var> change_jmx_auth <var>optionsOrConfigFile</var></pre>

  <p>Where:</p>
  <ul>
    <li><var>comp</var> is either <code>edge-management-server</code>, <code>edge-message-processor</code>,
    <code>edge-qpid-server</code>, or <code>edge-postgres-server</code>.</li>
    <li>Options are:
      <ul>
        <li><code>-u</code>: username</li>
        <li><code>-p</code>: password</li>
        <li><code>-e</code>: y (enable) or n (disable)</li>
      </ul>
    </li>
    <li>Config file includes:
      <ul>
        <li><code>JMX_USERNAME=<var>username</var></code></li>
        <li><code>JMX_ENABLED=y/n</code></li>
        <li><code>JMX_PASSWORD=<var>password</var></code> (if not set or not passed in with
          <code>-p</code>, you are prompted)</li>
      </ul>
    </li>
  </ul>

  <p>For example, to use options on the command line:</p>
  <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service edge-management-server change_jmx_auth -u foo -p bar -e y</pre>

  <p>If  you have a config file:</p>
  <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service edge-management-server change_jmx_auth -f <var>configFile</var></pre>

  <p>If you are running Edge on multiple nodes, run this command on all nodes, specifying the same
  username and password.</p>

  <p>To later disable JMX authentication, use the command:</p>
  <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service edge-management-server change_jmx_auth -e n</pre>

  <h2 id="managementserver">Management Server</h2>

  <h3 id="managementserver-usingjconsoletomonitorsystemhealthcheckandprocessinformation">Using
  JConsole to monitor system health check and process information</h3>

  <p>Use JConsole (a JMX compliant tool) to manage and monitor health check and process statistics.
  Using JConsole, you can consume JMX statistics exposed by Management Server (or any server) and
  display them in a graphical interface. For more information, see
  <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/management/jconsole.html" class="external">Using jconsole</a>.</p>

  <p>Use <code>JConsole</code> and the following service URL to monitor the JMX attributes
  (MBeans) offered via JMX.</p>
  <pre class="prettyprint">service:jmx:rmi:///jndi/rmi://<var>IP_address</var>:<var>port</var>/jmxrmi</pre>

  <p>Where <var>IP_address</var> is the IP address of Management Server (or respective server). By
  default, the port is 1099 for the Management Server.</p>

  <p>The following table shows the generic JMX statistics:</p>
  <table>
    <thead>
      <tr>
        <th>JMX MBeans</th>
        <th>JMX Attributes</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td rowspan="3">
          <p>Memory</p>
        </td>
        <td>
          <p>HeapMemoryUsage</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>NonHeapMemoryUsage</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>Usage</p>
        </td>
      </tr>
      <tr>
        <td colspan="2">
          <aside class="note"><strong>Note:</strong> Attribute values will be displayed in four
          values: committed, init, max, and used.</aside>
        </td>
      </tr>
    </tbody>
  </table>

  <h3 id="managementserver-usingedgeapplicationapichecks">Using Edge Application API checks</h3>

  <p>You can perform API check on the Management Server (or any server) by invoking the following
  CURL command:</p>
  <pre class="devsite-terminal">curl http://<var>host</var>:8080/v1/servers/self/up -H "Accept: application/json"</pre>

  <p>Where <var>host</var> is the IP address of Management Server. You can specify the
  <code>Accept</code> type as <code>application/json</code> or <code>application/xml</code>.</p>

  <p>This call returns the "true" and "false". If true, that means node is up and Java service is
  running.</p>

  <p>If you do not receive a HTTP 200 (OK) response, the Edge is unable to respond to port 8080
  requests.</p>

  <h4>Troubleshooting</h4>

  <ol>
    <li>Login to the server and run the following command:
      <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service edge-management-server status</pre>
    </li>
    <li>If the service is not running start the service:
      <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service edge-management-server start</pre>
    </li>
  </ol>

  <h3 id="managementserver-usingedgeapplicationusersorganizationanddeploymentchecks">Using Edge
  Application: Users, organization and deployment checks</h3>

  <p>Management Server plays a vital role in holding all other parcels together in each on-premises
  installation. You can check for user, organization and deployment status on the management server
  by issuing the following commands:</p>
  <pre class="devsite-terminal">curl -u <var>userEmail</var>:<var>password</var> http://localhost:8080/v1/users
<code class="devsite-terminal">curl -u <var>userEmail</var>:<var>password</var> http://localhost:8080/v1/organizations</code>
<code class="devsite-terminal">curl -u <var>userEmail</var>:<var>password</var> http://localhost:8080/v1/organizations/orgname/deployments</code></pre>

  <p>The system should display "deployed" status for all calls. If these fail, do the
  following:</p>
  <ol>
    <li>Check the Management Server logs (at <code>opt/apigee/var/log/edge-management-server</code>)
      for any errors.</li>
    <li>Make a call against Management Server to check whether it is functioning properly.</li>
    <li>Remove the server from the ELB and then restart the Management Server.
      <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service edge-management-server restart</pre>
    </li>
  </ol>

  <h2 id="router">Router</h2>

  <p>You can perform API check on the Router (or any server) by invoking the following CURL
  command:</p>
  <pre class="devsite-terminal">curl http://<var>host</var>:8081/v1/servers/self/up</pre>

  <p>Where, host is the IP address of Router.</p>

  <p>This call returns the "true" and "false". If true, that means the node is up and Router
  service is running.</p>

  <p>If you do not receive a <code>HTTP 200 (OK)</code> response, Edge is unable to respond to port
  8081 requests.</p>

  <h3 id="router-troubleshooting">Troubleshooting</h3>

  <ol>
    <li>Login to the server and run the following commands:
      <pre class="devsite-terminal">/<var>inst_root</var>/apigee/apigee-service/bin/apigee-service edge-router status</pre>
    </li>
    <li>If the service is not running start the service
      <pre class="devsite-terminal">/<var>inst_root</var>/apigee/apigee-service/bin/apigee-service edge-router start</pre>
    </li>
    <li>After restart check that it is functioning:
      <pre class="devsite-terminal">curl -v http://localhost:<var>port</var>/v1/servers/self/up</pre>
      <p>Where <var>port</var> is 8081 for Router and 8082 for Message Processor.</p>
    </li>
  </ol>

  <h3 id="router-usingjconsoletomonitorsystemhealthcheckandprocessinformation">Using
  JConsole to monitor system health check and process information</h3>

  <p>Follow the same as described above for the Management Server.</p>

  <aside class="note"><strong>Note</strong>: Ensure that you use port 1100.</aside>

  <h2 id="messageprocessor">Message Processor</h2>

  <h3 id="messageprocessor-usingjconsoletomonitorsystemhealthcheckandprocessinformation">Using
  JConsole to monitor system health check and process information</h3>

  <p>Follow the same as described above for the Management Server.</p>

  <aside class="note"><strong>Note</strong>: Ensure that you use port 1101.</aside>

  <h3 id="messageprocessor-usingedgeapplicationapichecks">Using Edge Application API checks</h3>

  <p>Follow the same as described above for the Router.</p>

  <aside class="note"><strong>Note</strong>: Ensure that you use port 8082.</aside>

  <h3 id="messageprocessor-usingjmxmessageflowchecks">Using JMX message flow checks</h3>

  <p>Follow the same as described above for the Management Server.</p>

  <aside class="note"><strong>Note</strong>: Ensure that you use port 1101.</aside>

  <h2 id="qpidserver">Qpid Server</h2>

  <h3 id="qpidserver-usingjconsoletomonitorsystemhealthcheckandprocessinformation">Using JConsole
  to monitor system health check and process information</h3>

  <p>Follow the same as described above for the Management Server.</p>

  <aside class="note"><strong>Note</strong>: Ensure that you use port 1102.</aside>

  <h3 id="qpidserver-usingedgeapplicationapichecks">Using Edge Application API checks</h3>

  <p>Follow the same as described above for the Management Server.</p>

  <aside class="note"><strong>Note</strong>: Ensure that you use port 8083. The following curl
  command is also supported for Qpid Server:
  <pre class="devsite-terminal">curl http://<var>qpid_IP</var>:8083/v1/servers/self</pre>
  </aside>

  <h2 id="postgresserver">Postgres Server</h2>

  <h3 id="postgresserver-usingjconsoletomonitorsystemhealthcheckandprocessinformation">Using
  JConsole to monitor system health check and process information</h3>

  <p>Follow the same as described above for the Management Server.</p>

  <aside class="note"><strong>Note</strong>: Ensure that you use port 1103.</aside>

  <h3 id="postgresserver-usingedgeapplicationapichecks">Using Edge Application API checks</h3>

  <p>Follow the same as described above for the Management Server.</p>

  <aside class="note"><strong>Note</strong>: Ensure that you use port 8084. The following curl
    command is also supported for Postgres Server:
    <pre class="devsite-terminal">curl http://<var>postgres_IP</var>:8084/v1/servers/self</pre>
  </aside>

  <h3 id="postgresserver-usingedgeapplicationorganizationandenvironmentchecks">Using Edge
  Application organization and environment checks</h3>

  <p>You can check for organization and environment name that are onboarded on the Postgres Server
  by issuing the following curl commands:
  <pre class="devsite-terminal">curl http://<var>postgres_IP</var>:8084/v1/servers/self/organizations</pre>

  <aside class="note"><strong>Note</strong>: Ensure that you use port 8084.</aside>

  <p>The system should display the organization and environment name.</p>

  <h3 id="postgresserver-usingedgeapplicationaxstatuscheck">Using Edge Application axstatus check</h3>

  <p>You can verify the status of the analytics servers by issuing the following CURL
  command.</p>
  <pre class="devsite-terminal">curl -u <var>userEmail</var>:<var>password</var> http://<var>host</var>:<var>port</var>/v1/organizations/<var>orgname</var>/environments/<var>envname</var>/provisioning/axstatus</pre>

  <p>The system should display SUCCESS status for all analytics servers. The output of above CURL
  command is shown below:</p>
  <pre class="prettyprint">
{
  "environments" : [ {
    "components" : [ {
      "message" : "success at Thu Feb 28 10:27:38 CET 2013",
      "name" : "pg",
      "status" : "SUCCESS",
      "uuid" : "[c678d16c-7990-4a5a-ae19-a99f925fcb93]"
     }, {
      "message" : "success at Thu Feb 28 10:29:03 CET 2013",
      "name" : "qs",
      "status" : "SUCCESS",
      "uuid" : "[ee9f0db7-a9d3-4d21-96c5-1a15b0bf0adf]"
     } ],
    "message" : "",
    "name" : "prod"
   } ],
  "organization" : "acme",
  "status" : "SUCCESS"
}
</pre>

  <h2 id="postgressqldatabase">PostgresSQL database</h2>

  <h3 id="postgressqldatabase-usingthecheck_postgresplscript">Using the check_postgres.pl script</h3>

  <p>To monitor the PostgresSQL database, you can use a standard monitoring script,
  <code>check_postgres.pl</code> which is available at
  <a href="https://bucardo.org/wiki/Check_postgres" class="external">http://bucardo.org/wiki/Check_postgres</a>.</p>

  <aside class="note"><strong>Note</strong>: The script, check_postgres.pl needs to be installed in
  each Postgres node.</aside>

  <p>Before you run the script:</p>
  <ol>
    <li>Ensure that you have installed <code>perl-Time-HiRes.x86_64</code>, a Perl module that
      implements high resolution alarm, sleep, gettimeofday, and interval timers. For example, you
      can install it by using the following command:<br>
      <pre class="devsite-terminal">yum install perl-Time-HiRes.x86_64</pre>
    </li>
  </ol>

  <p>The default output of the API calls using the script, <code>check_postgres.pl</code>, is Nagios
  compatible. After you install the script, do the following checks:</p>
  <ol>
    <li>Check the database size:
      <pre class="devsite-terminal">check_postgres.pl -H 10.176.218.202 -db apigee -u apigee -dbpass postgres -include=apigee -action database_size --warning='800 GB' --critical='900 GB'</pre>
    </li>
    <li>Check the number of incoming connections to the database and compares with maximum allowed
      connections:
      <pre class="devsite-terminal">check_postgres.pl -H 10.176.218.202 -db apigee -u apigee -dbpass postgres -action backends</pre>
    </li>
    <li>Check if database is running and available:
      <pre class="devsite-terminal">check_postgres.pl -H 10.176.218.202 -db apigee -u apigee -dbpass postgres -action connection</pre>
    </li>
    <li>Check the disk space:
      <pre class="devsite-terminal">check_postgres.pl -H 10.176.218.202 -db apigee -u apigee -dbpass postgres -action disk_space --warning='80%' --critical='90%'</pre>
    </li>
    <li>Check the number of organization and environment onboarded in a Postgres node:
      <pre class="devsite-terminal">check_postgres.pl -H 10.176.218.202 -db apigee -u apigee -dbpass postgres -action=custom_query --query="select count(*) as result from pg_tables where schemaname='analytics' and tablename like '%fact'" --warning='80' --critical='90' --valtype=integer</pre>
    </li>
  </ol>

  <aside class="note"><strong>Note</strong>: Please refer to
  <a href="https://bucardo.org/check_postgres/check_postgres.pl.html" class="external">http://bucardo.org/check_postgres/check_postgres.pl.html</a>
  in case you need any help on using the above commands.</aside>

  <h3 id="postgressqldatabase-dbchecks">DB checks</h3>

  <p>You can verify that the proper tables are created in PostgresSQL database. Log in to PostgreSQL
  database using the following command:</p>
  <pre class="devsite-terminal">psql -h /opt/apigee/var/run/apigee-postgresql/  -U apigee -d apigee</pre>

  <p>Then run:</p>
  <pre class="devsite-terminal">\d analytics."<var>org</var>.<var>env</var>.fact"</pre>

  <h3 id="postgressqldatabase-checkhealthstatusofpostgresprocess">Check health status of postgres
  process</h3>

  <p>You can perform API check on the postgres machine by invoking the following curl command:</p>
  <pre class="devsite-terminal">http://<var>postgres_IP</var>:8084/v1/servers/self/health/</pre>

  <aside class="note"><strong>Note</strong>: Ensure that you use port 8084.</aside>

  <p>It returns the <code>ACTIVE</code> status when postgres process is active. If the postgres
  process is not up and running, it returns the <code>INACTIVE</code> status.</p>

  <h3 id="postgressqldatabase-postgresresources">Postgres resources</h3>

  <ul>
    <li><a href="https://www.postgresql.org/docs/9.0/static/monitoring.html" class="external">http://www.postgresql.org/docs/9.0/static/monitoring.html</a></li>
    <li><a href="https://www.postgresql.org/docs/9.0/static/diskusage.html" class="external">http://www.postgresql.org/docs/9.0/static/diskusage.html</a></li>
    <li><a href="https://bucardo.org/check_postgres/check_postgres.pl.html" class="external">http://bucardo.org/check_postgres/check_postgres.pl.html</a></li>
  </ul>

  <h2 id="apachecassandra">Apache Cassandra</h2>

  <h3 id="apachecassandra-usingjconsolemonitortaskstatistics">Using JConsole: Monitor task
  statistics</h3>

  <p>Use JConsole and the following service URL to monitor the JMX attributes (MBeans) offered via
  JMX:</p>
  <pre class="prettyprint">service:jmx:rmi:///jndi/rmi://<var>IP_address</var>:7199/jmxrmi</pre>

  <p>Where <var>IP_address</var> is the IP of the Cassandra server.</p>

  <p>JMX is enabled by default for Cassandra and remote JMX access to Cassandra does not require a
  password.</p>

  <p>To enable JMX authentication to add a password:</p>
  <ol>
    <li>Edit <code>/opt/apigee/customer/application/cassandra.properties</code>. If the file does
      not exist, create it.</li>
    <li>Add the following to the file:
      <pre class="prettyprint">conf_cassandra-env_com.sun.management.jmxremote.authenticate=true</pre>
    </li>
    <li>Save the file.</li>
    <li>Copy the following files from your <code>$JAVA_HOME</code> directory to
    <code>/opt/apigee/data/apigee-cassandra/</code>:
    <pre class="devsite-terminal">cp ${JAVA_HOME}/lib/management/jmxremote.password.template $APIGEE_ROOT/data/apigee-cassandra/jmxremote.password
<code class="devsite-terminal">cp ${JAVA_HOME}/lib/management/jmxremote.access $APIGEE_ROOT/data/apigee-cassandra/jmxremote.access</code></pre>
    </li>
    <li>Edit <code>jmxremote.password</code> and add username and password to the file:
      <pre class="prettyprint">cassandra <var>password</var></pre>
      <p>Where <var>password</var> is the JMX password.</p>
    </li>
    <li>Edit <code>jmxremote.access</code> and add the following role:
      <pre class="prettyprint">cassandra readwrite</pre>
    </li>
    <li>Make sure the files are owned by "apigee" and that the file mode is 400:
      <pre class="devsite-terminal">chown apigee:apigee /opt/apigee/data/apigee-cassandra/jmxremote.*
<code class="devsite-terminal">chmod 400 /opt/apigee/data/apigee-cassandra/jmxremote.*</code></pre>
    </li>
    <li>Run <code>configure</code> on Cassandra:
      <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service apigee-cassandra configure</pre>
    </li>
    <li>Restart Cassandra:
      <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service apigee-cassandra restart</pre>
    </li>
  </ol>

  <p>To later disable authentication:</p>
  <ol>
    <li>Edit <code>/opt/apigee/customer/application/cassandra.properties</code>.</li>
    <li>Remove the following line in the file:
      <pre>conf_cassandra-env_com.sun.management.jmxremote.authenticate=true</pre>
    </li>
    <li>Run configure on Cassandra:
      <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service apigee-cassandra configure</pre>
    </li>
    <li>Restart Cassandra:
      <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service apigee-cassandra restart</pre>
    </li>
  </ol>

  <h3 id="apachecassandra-cassandrajmxstatistics">Cassandra JMX statistics</h3>

  <table>
    <thead>
      <tr>
        <th>JMX MBeans</th>
        <th>JMX Attributes</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td rowspan="15">
          <p>ColumnFamilies/apprepo/environments</p>
          <p>ColumnFamilies/apprepo/organizations</p>
          <p>ColumnFamilies/apprepo/apiproxy_revisions</p>
          <p>ColumnFamilies/apprepo/apiproxies</p>
          <p>ColumnFamilies/audit/audits</p>
          <p>ColumnFamilies/audit/audits_ref</p>
        </td>
        <td>
          <p>PendingTasks</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>MemtableColumnsCount</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>MemtableDataSize</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>ReadCount</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>RecentReadLatencyMicros</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>TotalReadLatencyMicros</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>WriteCount</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>RecentWriteLatencyMicros</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>TotalWriteLatencyMicros</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>TotalDiskSpaceUsed</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>LiveDiskSpaceUsed</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>LiveSSTableCount</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>BloomFilterFalsePositives</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>RecentBloomFilterFalseRatio</p>
        </td>
      </tr>
      <tr>
        <td>
          <p>BloomFilterFalseRatio</p>
        </td>
      </tr>
    </tbody>
  </table>

  <h3 id="apachecassandra-usingnodetoolutilitytomanageclusternodes">Using nodetool utility to
  manage cluster nodes</h3>

  <p>The nodetool utility, which is a command line interface for Cassandra, is used to manage
  cluster nodes. The utility can be found at <code>opt/apigee/apigee-cassandra/bin</code>.</p>

  <p>For more info on nodetool utility, see
  <a href="https://www.datastax.com/docs/1.0/references/nodetool" class="external">http://www.datastax.com/docs/1.0/references/nodetool</a>.</p>

  <p>The following calls can be made on all Cassandra cluster nodes:</p>
  <ol>
    <li><strong>General ring info</strong> (also possible for single Cassandra node): Look for the
    "Up" and "Normal" for all nodes.
    <pre class="devsite-terminal" data-terminal-prefix="[host]# ">nodetool -h localhost ring</pre>
    <p>The output of the above command looks as shown below:
    <pre class="prettyprint">Address         DC      Rack     Status State   Load    Owns    Token
192.168.124.201 dc1     ra1      Up     Normal  1.67 MB 33,33%  0
192.168.124.202 dc1     ra1      Up     Normal  1.68 MB 33,33%  56713727820156410577229101238628035242
192.168.124.203 dc1     ra1      Up     Normal  1.67 MB 33,33%  113427455640312821154458202477256070484</pre>
    </li>
    <li><strong>General info about nodes</strong> (call per node)
      <pre class="devsite-terminal" data-terminal-prefix="[host]# ">nodetool -h localhost info</pre>
      <p>The output of the above command looks as shown below:</p>
      <pre class="prettyprint">Token            : 0
Gossip active    : true
Load             : 1.67 MB
Generation No    : 1361968765
Uptime (seconds) : 78108
Heap Memory (MB) : 46,80 / 772,00
Data Center      : dc1
Rack             : ra1
Exceptions       : 0</pre>
    </li>
    <li><strong>Status of the thrift server</strong> (serving client API)
      <pre class="devsite-terminal" data-terminal-prefix="[host]# ">nodetool -h localhost statusthrift</pre>
      <p>The output of the above command displays status as "running".</p>
    </li>
    <li><strong>Status of data streaming operations</strong>: Observe traffic for cassandra nodes:
      <pre class="devsite-terminal" data-terminal-prefix="[host]# ">nodetool -h localhost netstats 192.168.124.203</pre>
      <p>The output of the above command looks as shown below:<br>
    <pre class="prettyprint">Mode: NORMAL
Nothing streaming to /192.168.124.203
Nothing streaming from /192.168.124.203
Pool Name    Active    Pending    Completed
Commands     n/a         0           1688
Responses    n/a         0          292277</pre>
    </li>
  </ol>

  <h3 id="apachecassandra-cassandramonitoringui">Cassandra Monitoring (UI)</h3>

  <p>Refer to the datastax opscenter URL: <a href=
  "https://www.datastax.com/products/opscenter" class="external">http://www.datastax.com/products/opscenter</a>.</p>

  <h3 id="apachecassandra-cassandraresource">Cassandra Resource</h3>

  <p>Refer to the following URL: <a href=
  "https://www.datastax.com/docs/1.0/operations/monitoring" class="external">http://www.datastax.com/docs/1.0/operations/monitoring</a>.</p>

  <h2 id="apachezookeeper">Apache ZooKeeper</h2>

  <h3 id="apachezookeeper-checkingzookeeperstatus">Checking ZooKeeper status</h3>

  <ol>
    <li>Ensure the ZooKeeper process is running. ZooKeeper writes a PID file to
      <code>opt/apigee/var/run/apigee-zookeeper/apigee-zookeeper.pid</code>.
    </li>
    <li>Test ZooKeeper ports to ensure that you can establish a TCP connection to ports 2181 and
      3888 on every ZooKeeper server.</li>
    <li>Ensure that you can read values from the ZooKeeper database. Connect using a ZooKeeper
      client library (or <code>/opt/apigee/apigee-zookeeper/bin/zkCli.sh</code>) and read a value
      from the database.</li>
    <li>Check the status:
      <pre class="devsite-terminal">/opt/apigee/apigee-service/bin/apigee-service apigee-zookeeper status</pre>
    </li>
  </ol>

  <h3 id="apachezookeeper-usingzookeeperfourletterwords">Using ZooKeeper four-letter words</h3>

  <p>ZooKeeper can be monitored via a small set of commands (four-letter words) that are sent to
  the port 2181 using netcat (nc) or telnet.</p>

  <p>For more info on ZooKeeper commands, see: <a href=
  "https://zookeeper.apache.org/doc/r3.1.2/zookeeperAdmin.html#sc_zkCommands" class="external">Apache ZooKeeper command reference</a>.</p>

  <p>For example:</p>

  <ul>
    <li><code>srvr</code>: Lists full details for the server.</li>
    <li><code>stat</code>: Lists brief details for the server and connected clients.</li>
  </ul>

  <p>The following commands can be issued to the ZooKeeper port:</p>
  <ol>
    <li>Run the four-letter command ruok to test if server is running in a non-error state. A
      successful response returns "imok".
      <pre class="devsite-terminal">echo ruok | nc <var>host</var> 2181</pre>
      <p>Returns:</p>
      <pre>imok</pre>
    </li>
    <li>Run the four-letter command, <code>stat</code>, to list server performance and connected
      clients statistics:
      <pre class="devsite-terminal">echo stat | nc <var>host</var> 2181</pre>
      <p>Returns:</p>
      <pre class="prettyprint">Zookeeper version: 3.4.5-1392090, built on 09/30/2012 17:52 GMT
Clients:
/0:0:0:0:0:0:0:1:33467[0](queued=0,recved=1,sent=0)
/192.168.124.201:42388[1](queued=0,recved=8433,sent=8433)
/192.168.124.202:42185[1](queued=0,recved=1339,sent=1347)
/192.168.124.204:39296[1](queued=0,recved=7688,sent=7692)
Latency min/avg/max: 0/0/128
Received: 26144
Sent: 26160
Connections: 4
Outstanding: 0
Zxid: 0x2000002c2
<strong>Mode: follower</strong>
Node count: 283</pre>

      <aside class="note"><strong>Note</strong>: It is sometimes important to see whether a ZooKeeper
      is in Mode: leader, follower or observer.</aside>
    </li>
    <li>If netcat (nc) is not available, you can use the python as an alternative. Create a file
    named <code>zookeeper.py</code> that contains the following:
    <pre class="prettyprint">import time, socket,
sys c = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
c.connect((sys.argv[1], 2181))
c.send(sys.argv[2])
time.sleep(0.1)
print c.recv(512)</pre>
    <p>Now run the following python lines:</p>
    <pre class="devsite-terminal">python zookeeper.py 192.168.124.201 ruok
<code class="devsite-terminal">python zookeeper.py 192.168.124.201 stat</code></pre>
    </li>
  </ol>

  <h2 id="openldap">OpenLDAP</h2>

  <h3 id="openldap-ldapleveltest">LDAP level test</h3>

  <p>You can monitor the OpenLDAP to see whether the specific requests are served properly. In
  other words, check for a specific search that returns the right result.</p>

  <ol>
    <li>Use <code>ldapsearch</code> (<code>yum install openldap-clients</code>) to query the entry
      of the system admin. This entry is used to authenticate all API calls.
      <pre class="devsite-terminal">ldapsearch -b "uid=admin,ou=users,ou=global,dc=apigee,dc=com" -x -W -D "cn=manager,dc=apigee,dc=com" -H ldap://localhost:10389 -LLL</pre>
      <p>You are then prompted for the LDAP admin password:</p>
      <pre class="devsite-terminal">Enter LDAP Password:</pre>
      <p>After entering the password, you see a response in the form:</p>
      <pre class="prettyprint">dn:
uid=admin,ou=users,ou=global,dc=apigee,dc=com
objectClass: organizationalPerson
objectClass: person
objectClass: inetOrgPerson
objectClass: top
uid: admin
cn: admin
sn: admin
userPassword:: e1NTSEF9bS9xbS9RbVNXSFFtUWVsU1F0c3BGL3BQMkhObFp2eDFKUytmZVE9PQ=
 =
mail: opdk@google.com</pre>
    </li>
    <li>Check whether Management Server is still connected to LDAP with the following command:
      <pre class="devsite-terminal">curl -u <var>userEMail</var>:<var>password</var> http://localhost:8080/v1/users/<var>ADMIN</var></pre>
      <p>Returns:</p>
      <pre class="prettyprint">{
  "emailId" : <var>ADMIN</var>,
  "firstName" : "admin",
  "lastName" : "admin"
}</pre>
    </li>
  </ol>

  <p>You can also monitor the OpenLDAP caches, which help in reducing the number of disk accesses
  and hence improve the performance of the system. Monitoring and then tuning the cache size in the
  OpenLDAP server can heavily impact the performance of the directory server. You can view the log
  files (<code>opt/apigee/var/log</code>) to obtain information about cache.</p>

{% endblock %}
