{% extends "private-cloud/v4.18.01/_base.html" %}
{% block title %}4.18.01 Rollback Process{% endblock %}
{% block body %}

  <p>In the event of an error during an update to Edge 4.18.01, you can roll back the component
  that caused the error and then try the update again. For example, if the update to Postgres 9.6
  fails, you can rollback just the Postgres nodes and try the update again.</p>

  <p>There are two scenarios where you might want to perform a rollback:</p>

  <ol>
    <li>Rollback to an older release. For example from 4.18.01 to 4.17.01.</li>
    <li>Rollback to an older version in the same release. </li>
  </ol>

  <p>Use the procedure below to perform a rollback for both scenarios.</p>

  <aside class="note"><strong>Note:</strong> The Edge all-in-one and 2-node topologies are designed for a
  getting started and prototyping environments, not for production. Therefore, there is no rollback
  procedure for the all-in-one and 2-node topologies. In the situation where the update of these
  topologies fails, try the update procedure again. If the update continues to fail after multiple
  attempts, then the easiest option is to do a fresh install of 4.18.01. </aside>

  <h2 id="whocanperformtherollback">Who can perform the rollback</h2>

  <p>The user performing the rollback should be the same as the user who originally updated Edge,
  or a user running as root.</p>

  <p>By default, Edge components run as the user "apigee". In some cases, you might be running Edge
  components as different users. For example, if the Router has to access privileged ports, such as
  those below 1000, then you have to run the Router as root or as a user with access to those
  ports. Or, you might run one component as one user, and another component as another user.</p>

  <h2 id="whichcomponentscanberolledback">Which components can be rolled back</h2>

  <p>You should be aware of the following conditions when performing a rollback:</p>

  <ul>
    <li>The five Edge components listed below share common code. Therefore, to rollback any one of
      the five components on a node, you must roll back any of the five installed on the node. For
      example, if you have the Management Server, Router, and Message Processor installed on the
      node, to roll back any one of them you must roll back all three.<br>
      <p>The five components that share code are:</p>
      <ul>
        <li>Management Server</li>
        <li>Router</li>
        <li>Message Processor</li>
        <li>Qpid Server</li>
        <li>Postgres Server</li>
      </ul>
    </li>

    <li><strong>If you are updating from Edge 4.16.01</strong>, do not rollback Cassandra. This
    release of Edge contains an updated version of Cassandra. If you rollback any components, leave
    Cassandra at the 4.18.01 version.</li>
  </ul>

  <h2 id="rollingback41801">Rolling back 4.18.01</h2>

  <p>This section contains the procedure to rollback Edge 4.18.01 to a previous version. This
  section is divided into two parts:</p>

  <ul>
    <li><strong>Rolling back the Postgres update</strong><br>
    The final part of every update procedure is to update Postgres nodes to version 9.6. If that
    update fails, then you can use this procedure to rollback the update.</li>

    <li><strong>Rolling back all other Edge components </strong><br>
    Use this procedure to rollback any other Edge components.</li>
  </ul>

  <h3 id="rollingback41801-torollbackthepostgres96update">To rollback the Postgres 9.6 update</h3>

  <p>To rollback the Postgres update when updating Postgres in a master-standby configuration,
  you:</p>

  <ul>
    <li>Promote the new standby node to become the Postgres master. The new Postgres master will be
    the same version as your previous Edge installation.</li>
    <li>Configure the old standby node to be a standby node of the new master. The old standby node
    will be the same version as your previous Edge installation.</li>
    <li>Register the new master and standby nodes with the analytics and consumer groups.</li>
  </ul>

  <p>When you are done with the rollback, the old master node will no longer be necessary. You can
  then decommission the old master node.</p>

  <aside class="note"><strong>Note:</strong> If you are performing an update in an environment that uses a
  single Postgres node, such as the all-in-one and 2-node topologies, there is no rollback
  procedure. In the situation where the update of these topologies fails, try the update procedure
  again. If the update continues to fail after multiple attempts, then the easiest option is to do
  a fresh install of 4.18.01.</aside>

  <ol>
    <li>Make sure the new standby Postgres node is running:
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-all status</pre>
      <p>If Postgres is not running, start it:</p>
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-all start</pre>
    </li>
    <li>Make sure Postgres is stopped on the old master node and old standby node:
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-all status</pre>
      <p>If Postgres is running, stop it:
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service edge-postgres-server stop &gt; /opt/apigee/apigee-service/bin/apigee-service apigee-postgresql stop</pre>
    </li>
    <li>If installed, start Qpid on the old standby node:
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service edge-qpid-server start</pre>
      <aside class="note"><strong>Note</strong>: In many configurations, the old standby node will
      only be hosting Postgres but not Qpid.</aside>
    </li>
    <li>Promote the new standby node as the Postgres master:
      <ol>
        <li>Promote the new standby node to be the <strong>new master</strong>:
          <pre>&gt; apigee-service apigee-postgresql promote-standby-to-master <var>new_standby_IP</var></pre>
          <p>If prompted, enter the Postgres password for the 'apigee' user, which defaults to
          "postgres".</p>
        </li>
        <li>Edit the config file that you used to install your current version of Edge to specify
          the following:
          <pre># IP address of the <strong>new master</strong>:
PG_MASTER=<var>new_standby_IP</var>
# IP address of the <strong>old standby</strong> node
PG_STANDBY=<var>old_standby_IP</var></pre>
        </li>
        <li>Configure the <strong>new master</strong>:<br>
          <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service apigee-postgresql setup-replication-on-master -f <var>configFile</var></pre>
        </li>
      </ol>
    </li>
    <li>Rebuild the old standby node:
      <ol>
        <li>Edit the config file that you used to install your current version of Edge to specify
          the following:
          <pre># IP address of the <strong>new master</strong>:
PG_MASTER=<var>new_standby_IP</var>
# IP address of the <strong>old standby</strong> node
PG_STANDBY=<var>old_standby_IP</var></pre>
        </li>
        <li>Remove data directory on the old standby node:
          <pre>&gt; cd /opt/apigee/data/apigee-postgresql/pgdata &gt; rm -rf *</pre>
        </li>
        <li>Reconfigure the old standby node to be a standby node of the new master:
          <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service apigee-postgresql setup-replication-on-standby -f <var>configFile</var></pre>
        </li>
        <li>Make sure Postgres is running on the old standby node:
          <pre>&gt; /opt/apigee/apigee-service/bin/apigee-all status</pre>
          <p>If it is not running, start it:</p>
          <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service edge-postgres-server start</pre>
        </li>
      </ol>
    </li>
    <li>Verify that the new standby node was added by viewing the
      <code>/opt/apigee/apigee-postgresql/conf/pg_hba.conf</code> file on the new master.
    </li>
    <li>View the current analytics and consumer group information by running the following command
    on the Management Server:
    <pre>&gt; curl -u <var>sysAdminEmail:password</var> http://<var>ms_IP</var>:8080/v1/analytics/groups/ax</pre>
    <p>This command returns the analytics group name in the <code>name</code> field, and the
    consumer group name in the <code>name</code> field under <code>consumer-groups</code>. It also
    returns the UUIDs of the old Postgres master and standby nodes in the
    <code>postgres-server</code> field, and in the <code>datastores</code> field.  You should see
    output in the form:
    <pre class="prettyprint">{
  <strong>"name" : "axgroup-001",</strong>
  "properties" : {
  },
  "scopes" : [ "VALIDATE~test", "sgilson~prod" ],
  "uuids" : {
    "qpid-server" : [ "8381a053-433f-4382-bd2a-100fd37a1592", "4b6856ec-ef05-498f-bac6-ef5f0d5f6521" ],
    <strong>"postgres-server" : [
      "ab1158bd-1d59-4e2a-9c95-24cc2cfa6edc:27f90844-efab-4b32-8a23-8f85cdc9a256"
    ]</strong>
  },
  <strong>"consumer-groups" : [ {
    "name" : "consumer-group-001",</strong>
    "consumers" : [ "8381a053-433f-4382-bd2a-100fd37a1592", "4b6856ec-ef05-498f-bac6-ef5f0d5f6521" ],
    "datastores" :
      <strong>[ "ab1158bd-1d59-4e2a-9c95-24cc2cfa6edc:27f90844-efab-4b32-8a23-8f85cdc9a256" ],</strong>
      "properties" : {     }
    }
  ],
  "data-processors" : {
  }
}</pre>
    </li>
    <li>Get the UUID address of the old master by running the following cURL command on the old
    master node:
      <pre>&gt; curl -u <var>sysAdminEmail:password</var> http://<var>node_IP</var>:8084/v1/servers/self</pre>
      <p>You should see the UUID of the node at the end of the output, in the form:
      <pre>"type" : [ "postgres-server" ],
<strong>"uUID" : "599e8ebf-5d69-4ae4-aa71-154970a8ec75"</strong></pre>
      <aside class="note"><strong>Note</strong>: The <code>edge-postgres-server</code> service must be
      running. If the Postgres server is not running, you can run the following command on the
      Management Server to determine the UUID:
      <pre>&gt; curl -u <var>sysAdminEmail:password</var> http://<var>ms_IP</var>:8080/v1/servers?pod=analytics</pre>
      <p>The output of this command lists the UUID for the IP address of each Postres node.</p>
    </li>
    <li>Repeat previous step to get the IP addresses of the old standby node and the new
    master.</li>
    <li>Remove old master and standby nodes from the consumer group:
      <pre>&gt; curl -u <var>sysAdminEmail:password</var> -X DELETE
  "http://<var>ms_IP</var>:8080/v1/analytics/groups/ax/<var>axgroup-001</var>/consumer-groups/<var>consumer-group-001</var>/datastores/<var>masterUUID,standbyUUID</var>" -v</pre>
      <p>where <var>axgroup-001</var> and <var>consumer-group-001</var> are the default names of the
      analytics and consumer groups. <var>masterUUID,standbyUUID</var> are in the same order as they
      appeared above when you viewed the current analytics and consumer group information above. You
      might have to specify them as <var>standbyUUID,masterUUID</var>.</p>
      <p>The <code>datastores</code> property for <code>consumer-groups</code> should now be
      empty.</p>
    </li>
    <li>Remove the old master and standby nodes from the analytics group:
    <pre>&gt; curl -u <var>sysAdminEmail:password</var> -X DELETE
  "http://<var>ms_IP</var>:8080/v1/analytics/groups/ax/<var>axgroup-001</var>/servers?uuid=<var>masterUUID,standbyUUID</var>&amp;type=postgres-server" -v</pre>
    <p>The <code>postgres-server</code> property under <code>uuids</code> should now be empty.</li>

    <li>Register new PG master and standby nodes with the analytics and consumer groups:<br>
      <pre>&gt; curl -u <var>sysAdminEmail:password</var> -X POST -H "Content-Type: application/json" -d ''
  "http://<var>ms_IP</var>:8080/v1/analytics/groups/ax/<var>axgroup-001</var>/servers?uuid=<var>masterUUID,standbyUUID</var>&amp;type=postgres-server" -v
&gt; curl -u <var>sysAdminEmail:password</var> -X POST -H "Content-Type:application/json" -d ''
  "http://<var>ms_IP</var>:8080/v1/analytics/groups/ax/<var>axgroup-001</var>/consumer-groups/<var>consumer-group-001</var>/datastores?uuid=<var>masterUUID,standbyUUID</var>" -v</pre>
  </li>
    <li>Validate the analytics group:
      <pre>&gt; curl -u <var>sysAdminEmail:password</var> http://<var>ms_IP</var>:8080/v1/analytics/groups/ax</pre>
      <p>You should see the UUIDs of the new master and standby nodes listed in the analytics group and
      the consumer group.</p>
    </li>
    <li>Restart the Edge Management Server:
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service edge-management-server restart</pre>
    </li>
    <li>Restart all Qpid servers:<br>
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service edge-qpid-server restart</pre>
    </li>
    <li>Restart all Postgres servers:<br>
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service edge-postgres-server restart</pre>
    </li>
    <li>Verify the replication status by issuing the following scripts on both servers. The system
      should display identical results on both servers to ensure a successful replication:<br>
      <p>On the the new master, run:
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service apigee-postgresql postgres-check-master</pre>
      <p>Validate that it says it is the master. On the old standby node:
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service apigee-postgresql postgres-check-standby</pre>
      <p>Validate that it says it is the standby.</p>
    </li>
    <li>Repeat the previous step after making several API requests to ensure that the nodes are in
    synch. </li>

    <li>Decommission the old Postgres master using the procedure in
      <a href="/private-cloud/v4.17.09/update-apigee-edge-4160141605-41709">Update Apigee Edge
      4.16.01/4.16.05 to 4.17.09</a>.
      <aside class="note"><strong>Note</strong>: If the old master node was running Qpid, you can
        leave that server up to run Qpid. Ensure that it is running. If not, start it:
        <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service edge-management-server start</pre>
      </aside>
      <p>Alternatively, you can uninstall Qpid from the old master and install Qpid on the new master
      node, as described below. After uninstalling Qpid, you can decommission the old master
      node.</p>
    </li>
  </ol>

  <h4>Uninstal Qpid from the old master and install Qpid on the new master</h4>

  <p>Use the following procedure to uninstall Qpid from the old master and install it on the new
  master:</p>

  <ol>
    <li>Block access to Qpid port 5672 on the old master from access by Message Processors by
      running the following command on all Message Processors:
      <pre>&gt; iptables -A OUTPUT -p tcp -d 10.233.147.20 --dport 5672 -j DROP</pre>
    </li>

    <li>Ensure that the Qpid message queue is empty by running the following command. You cannot
      uninstall Qpid until it has processed all pending messages:
      <pre>&gt; qpid-stat -q</pre>
      <p>This command displays a table containing a count for <code>msg, msgIn, and msgOut</code>.
      All messages will have been processed when <code>msg=0</code>,
      and <code>msgIn=msgOut</code>.</p>
    </li>

    <li>Determine the UUID of the Qpid server on the old master by running the following command on
      the old master. Save this information for later in the procedure:
      <pre>&gt; curl -u <var>sysAdminEmail:password</var> http://<var>node_IP</var>::8083/v1/servers/self</pre>
    </li>
    <li>Stop Qpid on the old master:
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service edge-qpid-server stop
&gt; /opt/apigee/apigee-service/bin/apigee-service apigee-qpidd stop</pre>
    </li>
    <li>Uninstall Qpid server:
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service edge-qpid-server uninstall
&gt; /opt/apigee/apigee-service/bin/apigee-service apigee-qpidd uninstall</pre>
    </li>
    <li>Remove the old Qpid server from the analytics and consumer groups:
      <pre>&gt; curl -u <var>sysAdminEmail:password</var> -X DELETE -H "Content-Type: application/json" -d ''
  "http://<var>ms_IP</var>:8080/v1/analytics/groups/ax/<var>axgroup-001</var>/consumer-groups/<var>consumer-group-001/consumers</var>/<var>qpid_UUID</var>" -v
&gt; curl -u <var>sysAdminEmail:password</var> -X DELETE
  "http://<var>ms_IP</var>:8080/v1/analytics/groups/ax/<var>axgroup-001</var>/servers?uuid=<var>qpid_UUID</var>&amp;type=qpid-server" -v</pre>
    </li>
    <li>Remove the old Qpid server from Zookeeper:
      <pre>&gt; curl -u <var>sysAdminEmail:password</var> -X DELETE
  http://<var>ms_IP</var>:8080/v1/servers/<var>qpid_UUID</var></pre>
    </li>
    <li>Install Qpid on the new master:
      <pre>&gt; /opt/apigee/apigee-setup/bin/setup.sh -p qs -f <var>configFile</var></pre>
    </li>
    <li>Determine the UUID of the Qpid server on the new master by running the following command on
      the new master. Save this information for later in the procedure:
      <pre>&gt; curl -u <var>sysAdminEmail:password</var>
  http://<var>node_IP</var>::8083/v1/servers/self</pre>
    </li>
    <li>Register the new Qpid server with the analytics and consumer groups:
      <pre>&gt; curl -u <var>sysAdminEmail:password</var> -X POST -H "Content-Type: application/json" -d ''
  "http://<var>ms_IP</var>:8080/v1/analytics/groups/ax/<var>axgroup-001</var>/servers?uuid=<var>qpid_UUID</var>&amp;type=qpid-server" -v
&gt; curl -u <var>sysAdminEmail:password</var> -X POST -H "Content-Type:application/json" -d ''
  "http://<var>ms_IP</var>:8080/v1/analytics/groups/ax/<var>axgroup-001</var>/consumer-groups/<var>consumer-group-001</var>/consumers?uuid=<var>qpid_UUID</var>" -v</pre>
    </li>
    <li>Restart all Message Processors:
      <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service edge-message-processor restart</pre>
    </li>
    <li>Run the following command on the new Qpid server to check that queues were created:<br>
      <pre>&gt; qpid-stat -q</pre>
      <p>Ensure that you see <cpde>msg, msgIn, and msgOut</cpde> being updated as the Qpid server
      processes messages.</p>
    </li>
  </ol>

  <h2 id="torollbackindividualcomponentsfrom41801">To rollback individual components from
  4.18.01 </h2>

  <p>As part of performing the rollback, you have to download the bootstrap.sh file for your
  current version of Edge:</p>
  <ul>
    <li>For rolling back to 4.17.09, download <code>bootstrap_4.17.09.sh</code></li>
    <li>For rolling back to 4.17.05, download <code>bootstrap_4.17.05.sh</code></li>
    <li>For rolling back to 4.17.01, download <code>bootstrap_4.17.01.sh</code></li>
    <li>For rolling back to 4.16.09, download <code>bootstrap_4.16.09.sh</code></li>
    <li>For rolling back to 4.16.05, download <code>bootstrap_4.16.05.sh</code></li>
    <li>For rolling back to 4.16.01, download <code>bootstrap.sh</code></li>
  </ul>
  <p>For each node hosting a component to roll back:</p>
  <ol>
    <li>Stop the component to rollback:
      <ol>
        <li><strong>If you are rolling back any one of the following components on the node, you must
          stop them all: Management Server, Router, Message Processor, Qpid Server, or Postgres
          Server:</strong>
          <ul>
            <li><pre>&gt; apigee-service edge-management-server stop</pre></li>
            <li><pre>&gt; apigee-service edge-router stop</pre></li>
            <li><pre>&gt; apigee-service edge-message-processor stop</pre></li>
            <li><pre>&gt; apigee-service edge-qpid-server stop</pre></li>
            <li><pre>&gt; apigee-service edge-postgres-server stop</pre></li>
          </ul>
        </li>
        <li><strong>If you are rolling back any other component on the node, stop just that
          component:</strong>
          <ul>
            <li><pre>&gt; apigee-service <var>comp</var> stop</pre></li>
          </ul>
        </li>
      </ol>
    </li>
    <li>If you are rolling back Monetization, uninstall it from all Management Server and Message
      Processor nodes:
      <pre>&gt; apigee-service edge-mint-gateway uninstall</pre>
    </li>
    <li>Uninstall the component to rollback on the node:
      <ol>
        <li><strong>If you are rolling back any of the following components on the node, then
          uninstall them all: Management Server, Router, Message Processor, Qpid Server, or Postgres
          Server:</strong>
          <pre>&gt; apigee-service edge-gateway uninstall</pre>
        </li>

        <li><strong>If you are rolling back any other component on the node, uninstall just that
          component:</strong>
          <pre>&gt; apigee-service <var>comp</var> uninstall</pre>
        </li>
        <li><strong>If you are rolling back the Router</strong>, then you have to delete the
          contents of <code>/opt/nginx/conf.d</code>:
          <pre>&gt; cd /opt/nginx/conf.d
&gt; rm -rf *</pre>
        </li>
      </ol>
    </li>

    <li>
      <strong>To rollback the component:</strong>
      <ol>
        <li>Uninstall the 4.18.01 version of <code>apigee-setup</code>:
          <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service apigee-setup uninstall</pre>
        </li>
        <li>Download bootstrap.sh for the desired release: <strong>For example, for 4.16.09</strong>:
          <pre>&gt; curl https://software.apigee.com/bootstrap_4.16.09.sh -o /tmp/bootstrap_4.16.09.sh </pre>
        </li>
        <li>Install the 4.16.01, 4.16.05, or 4.16.09 <code>apigee-service</code> utility and
          dependencies. <strong>For example, for 4.16.09</strong>:
          <pre>&gt; sudo bash /tmp/bootstrap_4.16.09.sh apigeeuser=<var>uName</var> apigeepassword=<var>pWord</var></pre>
          <p>where <var>uName</var> and <var>pWord</var> are the username and password you received
          from Apigee. If you omit <var>pWord</var>, you will be prompted to enter
          it.</p>
        </li>
        <li>Install <code>apigee-setup</code>:
          <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service apigee-setup install</pre>
        </li>
        <li>Install the desired version of the component:
          <pre>&gt; /opt/apigee/apigee-setup/bin/setup.sh -p <em><strong>comp</strong></em> -f <var>configFile</var></pre>
          <p>where <var>comp</var> is the component to install and <var>configFile</var> is your
          configuration file for the desired version.</p>
        </li>
        <li>If you are rolling back Qpid, flush iptables:
          <pre>&gt; sudo iptables -F</pre>
        </li>
      </ol>
    </li>
    <li><strong>To rollback the component to a specific version of the 4.18.01 release:</strong>
      <ol>
        <li>Download the specific component version:
          <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service <var>comp-version</var> install</pre>
          <p>where <var>comp-version</var> is the component and version to install. For example:
          <pre>&gt; /opt/apigee/apigee-service/bin/apigee-service edge-ui-4.17.09-0.0.3749 install</pre>
          <p>If you are using the Apigee online repo, you can determine the available component versions
          by using the following command:
          <pre>&gt; yum --showduplicates list comp</pre>
          <p>For example:</p>
          <pre>&gt; yum --showduplicates list edge-ui</pre>
        </li>
        <li>Use <code>apigee-setup</code> to install the component:
          <pre>&gt; /opt/apigee/apigee-setup/bin/setup.sh -p <var>comp</var> -f <var>configFile</var></pre>
          <p>For example:</p>
          <pre>&gt; /opt/apigee/apigee-setup/bin/setup.sh -p ui -f <var>configFile</var></pre>
          <p>Note how you only specify the component name when you do the install.</p>
        </li>
      </ol>
    </li>
  </ol>

  <p>Contact {{support}} if you encounter issues when rolling back.</p>
{% endblock %}
